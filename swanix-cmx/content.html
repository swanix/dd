<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contenido Protegido</title>
    <link rel="stylesheet" href="/assets/css/main.css">
</head>
<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>Aplicación</h2>
            </div>
            <nav class="sidebar-nav">
                <ul>
                    <li><a href="/app/" class="nav-link">Inicio</a></li>
                    <li><a href="/app/content.html" class="nav-link active">Content</a></li>
                </ul>
            </nav>
        </aside>
        
        <div class="main-content">
            <header class="topbar">
                <div class="topbar-left">
                    <h1>Dashboard</h1>
                </div>
                <div class="topbar-right">
                    <div class="user-menu">
                        <button id="userButton" class="user-button">
                            <div class="user-avatar">
                                <span id="userInitial">U</span>
                            </div>
                            <span id="userName">Usuario</span>
                            <i>▼</i>
                        </button>
                        <div class="user-dropdown" id="userDropdown">
                            <div class="user-dropdown-item">
                                <span id="userEmail">usuario@email.com</span>
                            </div>
                            <div class="user-dropdown-item">
                                <span id="userId">user-id</span>
                            </div>
                            <a href="#" class="user-dropdown-item logout" id="logoutButton">
                                <span>Cerrar Sesión</span>
                            </a>
                        </div>
                    </div>
                </div>
            </header>
            
            <main class="content-area">
                <!-- Menú horizontal para subsecciones -->
                <div class="horizontal-nav">
                    <nav class="sub-nav">
                        <ul>
                            <li><a href="#" class="sub-nav-link active" data-content="dashboard">Dashboard</a></li>
                            <li><a href="#" class="sub-nav-link" data-content="documentos">Documentos</a></li>
                            <li><a href="#" class="sub-nav-link" data-content="configuracion">Configuración</a></li>
                        </ul>
                    </nav>
                </div>

                <div class="content-header">
                    <h2>Bienvenido</h2>
                    <p>Selecciona una sección para ver el contenido protegido</p>
                </div>

                <div id="contentContainer">
                    <div class="loading">Selecciona una sección del menú...</div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="https://cdn.auth0.com/js/auth0-spa-js/1.13/auth0-spa-js.production.js"></script>
    <script src="/assets/js/env-config.js"></script>
    <script src="/assets/js/content-loader.js"></script>
    
    <script>
        // ===== CARGADOR DE CONTENIDO PROTEGIDO =====
        // Este script carga contenido markdown protegido desde el servidor

        class ContentExampleLoader {
            constructor() {
                this.auth0 = null;
                this.contentLoader = null;
                this.init();
            }

            async init() {
                try {
                    // Configuración de Auth0
                    const auth0Config = window.AUTH0_CONFIG || {
                        domain: window.AUTH0_CONFIG?.domain || '',
                        client_id: window.AUTH0_CONFIG?.client_id || '',
                        redirect_uri: window.location.origin + '/app/content.html',
                        cacheLocation: 'localstorage'
                    };

                    // Crear cliente Auth0
                    this.auth0 = await createAuth0Client(auth0Config);
                    
                    // Verificar autenticación
                    const isAuthenticated = await this.auth0.isAuthenticated();
                    
                    if (!isAuthenticated) {
                        console.log('Usuario no autenticado, redirigiendo a login');
                        window.location.replace('/login.html');
                        return;
                    }

                    // Inicializar ContentLoader
                    this.contentLoader = new ContentLoader();
                    await this.contentLoader.init(this.auth0);
                    
                    // Cargar información del usuario
                    await this.loadUserInfo();
                    
                    // Inicializar interfaz de usuario
                    this.initializeUserInterface();
                    
                    // Configurar navegación
                    this.setupNavigation();
                    
                    // Cargar contenido inicial
                    this.loadInitialContent();
                    
                } catch (error) {
                    console.error('Error inicializando contenido:', error);
                    window.location.replace('/login.html');
                }
            }

            async loadUserInfo() {
                try {
                    const user = await this.auth0.getUser();
                    if (user) {
                        // Actualizar información del usuario en la interfaz
                        const userInitial = document.getElementById('userInitial');
                        const userName = document.getElementById('userName');
                        const userEmail = document.getElementById('userEmail');
                        const userId = document.getElementById('userId');
                        
                        if (user.name) {
                            userName.textContent = user.name;
                            userInitial.textContent = user.name.charAt(0).toUpperCase();
                        }
                        
                        if (user.email) {
                            userEmail.textContent = user.email;
                        }
                        
                        if (user.sub) {
                            userId.textContent = user.sub;
                        }
                        
                        // Actualizar avatar con foto si está disponible
                        const userAvatar = document.querySelector('.user-avatar');
                        if (user.picture && userAvatar) {
                            userAvatar.innerHTML = `<img src="${user.picture}" alt="${user.name || 'Usuario'}">`;
                        }
                    }
                } catch (error) {
                    console.error('Error cargando información del usuario:', error);
                }
            }
            
            initializeUserInterface() {
                const userButton = document.getElementById('userButton');
                const userDropdown = document.getElementById('userDropdown');
                const logoutButton = document.getElementById('logoutButton');
                
                if (userButton && userDropdown && logoutButton) {
                    // Toggle del dropdown
                    userButton.addEventListener('click', function() {
                        userDropdown.classList.toggle('show');
                    });
                    
                    // Cerrar dropdown al hacer clic fuera
                    document.addEventListener('click', function(event) {
                        if (!userButton.contains(event.target)) {
                            userDropdown.classList.remove('show');
                        }
                    });
                    
                    // Logout
                    logoutButton.addEventListener('click', function(e) {
                        e.preventDefault();
                        this.auth0.logout({
                            returnTo: window.location.origin + '/login.html'
                        });
                    }.bind(this));
                }
            }

            setupNavigation() {
                const navLinks = document.querySelectorAll('.sub-nav-link[data-content]');
                const contentContainer = document.getElementById('contentContainer');
                
                navLinks.forEach(link => {
                    link.addEventListener('click', async (e) => {
                        e.preventDefault();
                        
                        // Remover clase active de todos los links
                        navLinks.forEach(l => l.classList.remove('active'));
                        
                        // Agregar clase active al link clickeado
                        link.classList.add('active');
                        
                        // Cargar contenido
                        const contentPath = link.getAttribute('data-content');
                        try {
                            await this.contentLoader.loadContent(contentPath, {
                                targetElement: contentContainer,
                                format: 'json',
                                showLoading: true
                            });
                        } catch (error) {
                            console.error('Error cargando contenido:', error);
                            contentContainer.innerHTML = `
                                <div class="error-message">
                                    <h3>Error cargando contenido</h3>
                                    <p>${error.message}</p>
                                    <button onclick="location.reload()">Reintentar</button>
                                </div>
                            `;
                        }
                    });
                });
            }

            loadInitialContent() {
                const urlParams = new URLSearchParams(window.location.search);
                const initialContent = urlParams.get('content') || 'dashboard';
                
                // Activar el link correspondiente
                const initialLink = document.querySelector(`[data-content="${initialContent}"]`);
                if (initialLink) {
                    initialLink.classList.add('active');
                    initialLink.click();
                }
            }
        }

        // Inicializar cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', () => {
            new ContentExampleLoader();
        });
    </script>
</body>
</html>
