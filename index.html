<!DOCTYPE html>
<html lang="es">
<head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta charset="UTF-8" />
  <meta name="robots" content="noindex, nofollow, noarchive" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <link rel="shortcut icon" href="img/favicon.ico">
  <meta name="llm-context" content="data/context.md">
  <meta name="ai-context" content="data/context.md">
  <link rel="context" href="data/context.md" type="text/markdown">
  <meta name="description" content="Diagrama interactivo de secciones. Contexto completo en data/context.md">
  <title>Diagram</title>
  <link href="https://cdn.jsdelivr.net/gh/swanix/diagrams@v0.9.1/dist/xdiagrams.min.css" rel="stylesheet" />
  <style>
    .auth-container {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      flex-direction: column;
      gap: 20px;
    }
    .login-btn {
      padding: 12px 24px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    .user-info {
      text-align: center;
      margin-bottom: 20px;
    }
    .logout-btn {
      padding: 8px 16px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-left: 10px;
    }
    .debug-info {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 10px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
      max-width: 300px;
      z-index: 1000;
    }
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      flex-direction: column;
      gap: 20px;
    }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #007bff;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="custom-theme">

<div id="app"></div>

<script>
  console.log('üîß Configurando xDiagrams...');
  window.$xDiagrams = {
    url: "https://api.sheetbest.com/sheets/28f15681-b2ab-47a0-bbcb-205d142d9ef7/tabs/All",
    title: "Inspector",
    clustersPerRow: "6 3 7 6 3",
    showThemeToggle: false 
  };
  console.log('‚úÖ xDiagrams configurado:', window.$xDiagrams);
</script>

<script src="https://cdn.auth0.com/js/auth0-spa-js/1.22/auth0-spa-js.production.js"></script>
<script>
  let auth0 = null;
  let debugInfo = null;
  let xDiagramsLoaded = false;

  const showDebugInfo = (message) => {
    console.log('üîç DEBUG:', message);
    if (!debugInfo) {
      debugInfo = document.createElement('div');
      debugInfo.className = 'debug-info';
      document.body.appendChild(debugInfo);
    }
    debugInfo.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${message}</div>`;
  };

  const loadXDiagramsScript = () => {
    return new Promise((resolve, reject) => {
      showDebugInfo('üì• Cargando script de xDiagrams...');
      
      // Asegurar que $xDiagrams est√© disponible antes de cargar el script
      if (!window.$xDiagrams) {
        showDebugInfo('‚ö†Ô∏è $xDiagrams no est√° disponible, restaurando configuraci√≥n...');
        window.$xDiagrams = {
          url: "https://api.sheetbest.com/sheets/28f15681-b2ab-47a0-bbcb-205d142d9ef7/tabs/All",
          title: "Inspector",
          clustersPerRow: "6 3 7 6 3",
          showThemeToggle: false 
        };
        showDebugInfo('‚úÖ Configuraci√≥n de $xDiagrams restaurada');
      }
      
      const script = document.createElement('script');
      script.type = 'module';
      script.src = 'https://cdn.jsdelivr.net/gh/swanix/diagrams@v0.9.1/dist/xdiagrams.min.js?v=' + Date.now();
      
      script.onload = () => {
        showDebugInfo('‚úÖ Script de xDiagrams cargado');
        resolve();
      };
      
      script.onerror = () => {
        showDebugInfo('‚ùå Error cargando script de xDiagrams');
        reject(new Error('No se pudo cargar el script de xDiagrams'));
      };
      
      document.head.appendChild(script);
    });
  };

  const checkXDiagrams = () => {
    showDebugInfo('üîç Verificando xDiagrams...');
    
    // Verificar diferentes formas de detectar xDiagrams
    if (window.xDiagrams) {
      showDebugInfo('‚úÖ xDiagrams encontrado en window.xDiagrams');
      xDiagramsLoaded = true;
      return true;
    }
    
    // ¬°NUEVO! Verificar XDiagrams con X may√∫scula
    if (window.XDiagrams) {
      showDebugInfo('‚úÖ XDiagrams encontrado en window.XDiagrams');
      xDiagramsLoaded = true;
      return true;
    }
    
    if (window.$xDiagrams) {
      showDebugInfo('‚úÖ $xDiagrams encontrado en window.$xDiagrams');
    }
    
    if (typeof xDiagrams !== 'undefined') {
      showDebugInfo('‚úÖ xDiagrams encontrado como variable global');
      xDiagramsLoaded = true;
      return true;
    }
    
    // Verificar si hay elementos del diagrama en el DOM
    const diagramElements = document.querySelectorAll('[data-xdiagrams], .xdiagrams, #xdiagrams');
    if (diagramElements.length > 0) {
      showDebugInfo(`‚úÖ Elementos de diagrama encontrados: ${diagramElements.length}`);
      xDiagramsLoaded = true;
      return true;
    }
    
    // Verificar si el script se carg√≥
    const scripts = document.querySelectorAll('script');
    const xDiagramsScript = Array.from(scripts).find(script => 
      script.src && script.src.includes('xdiagrams')
    );
    
    if (xDiagramsScript) {
      showDebugInfo('‚úÖ Script de xDiagrams encontrado en DOM');
    } else {
      showDebugInfo('‚ùå Script de xDiagrams no encontrado en DOM');
    }
    
    showDebugInfo('‚ùå xDiagrams no est√° disponible como objeto');
    return false;
  };

  const initializeDiagram = () => {
    showDebugInfo('üöÄ Inicializando diagrama...');
    
    try {
      // Verificar si XDiagrams tiene un m√©todo de inicializaci√≥n
      if (window.XDiagrams && typeof window.XDiagrams.init === 'function') {
        showDebugInfo('‚úÖ Llamando XDiagrams.init()');
        window.XDiagrams.init();
        return true;
      }
      
      // Verificar si XDiagrams tiene un m√©todo render
      if (window.XDiagrams && typeof window.XDiagrams.render === 'function') {
        showDebugInfo('‚úÖ Llamando XDiagrams.render()');
        window.XDiagrams.render();
        return true;
      }
      
      // Verificar si XDiagrams tiene un m√©todo start
      if (window.XDiagrams && typeof window.XDiagrams.start === 'function') {
        showDebugInfo('‚úÖ Llamando XDiagrams.start()');
        window.XDiagrams.start();
        return true;
      }
      
      // Verificar si el script se ejecuta autom√°ticamente
      showDebugInfo('üîç Verificando si el script se ejecuta autom√°ticamente...');
      
      // Esperar un poco m√°s para ver si el script se inicializa solo
      setTimeout(() => {
        showDebugInfo('‚è≥ Esperando inicializaci√≥n autom√°tica...');
        
        // Verificar si aparecieron elementos del diagrama
        const diagramElements = document.querySelectorAll('[data-xdiagrams], .xdiagrams, #xdiagrams, .diagram, [class*="diagram"]');
        if (diagramElements.length > 0) {
          showDebugInfo(`‚úÖ Elementos de diagrama aparecieron autom√°ticamente: ${diagramElements.length}`);
          diagramElements.forEach((el, index) => {
            showDebugInfo(`Elemento ${index + 1}: ${el.tagName} - ${el.className || el.id}`);
          });
        } else {
          showDebugInfo('‚ùå No aparecieron elementos autom√°ticamente');
        }
      }, 3000);
      
      // Si no hay m√©todos espec√≠ficos, intentar crear el diagrama manualmente
      showDebugInfo('üîß Intentando crear diagrama manualmente...');
      
      // Verificar si hay un div app donde renderizar
      const appDiv = document.getElementById('app');
      if (appDiv) {
        showDebugInfo('‚úÖ Div app encontrado, intentando renderizar diagrama');
        
        // Intentar diferentes formas de inicializar
        if (window.XDiagrams && window.XDiagrams.create) {
          showDebugInfo('‚úÖ Usando XDiagrams.create()');
          window.XDiagrams.create(appDiv);
          return true;
        }
        
        if (window.XDiagrams && window.XDiagrams.mount) {
          showDebugInfo('‚úÖ Usando XDiagrams.mount()');
          window.XDiagrams.mount(appDiv);
          return true;
        }
        
        // Si nada funciona, intentar forzar la inicializaci√≥n
        showDebugInfo('üîß Forzando inicializaci√≥n del diagrama...');
        
        // Crear un elemento para el diagrama
        const diagramDiv = document.createElement('div');
        diagramDiv.id = 'xdiagrams-container';
        diagramDiv.className = 'xdiagrams';
        appDiv.appendChild(diagramDiv);
        
        showDebugInfo('‚úÖ Elemento de diagrama creado');
        
        // Intentar disparar un evento de inicializaci√≥n
        const initEvent = new CustomEvent('xdiagrams-init', {
          detail: { container: diagramDiv }
        });
        document.dispatchEvent(initEvent);
        
        showDebugInfo('‚úÖ Evento de inicializaci√≥n disparado');
        return true;
      }
      
      showDebugInfo('‚ùå No se pudo inicializar el diagrama');
      return false;
      
    } catch (error) {
      showDebugInfo(`‚ùå Error inicializando diagrama: ${error.message}`);
      console.error('Error inicializando diagrama:', error);
      return false;
    }
  };

  const investigateScript = () => {
    showDebugInfo('üî¨ Investigando script de xDiagrams...');
    
    // Verificar todas las propiedades de window que podr√≠an ser xDiagrams
    const possibleNames = [
      'xDiagrams', 'XDiagrams', 'xdiagrams', 'XDIAGRAMS',
      'diagrams', 'Diagrams', 'DIAGRAMS',
      'swanix', 'Swanix', 'SWANIX'
    ];
    
    for (const name of possibleNames) {
      if (window[name]) {
        showDebugInfo(`‚úÖ Encontrado: window.${name}`);
        console.log(`window.${name}:`, window[name]);
        
        // Si es XDiagrams, investigar sus m√©todos
        if (name === 'XDiagrams') {
          showDebugInfo('üîç Investigando m√©todos de XDiagrams...');
          const methods = Object.getOwnPropertyNames(window[name]).filter(prop => 
            typeof window[name][prop] === 'function'
          );
          showDebugInfo(`M√©todos disponibles: ${methods.join(', ')}`);
          console.log('M√©todos de XDiagrams:', methods);
          
          // Mostrar propiedades del objeto
          const properties = Object.getOwnPropertyNames(window[name]);
          showDebugInfo(`Propiedades disponibles: ${properties.join(', ')}`);
          console.log('Propiedades de XDiagrams:', properties);
        }
      }
    }
    
    // Verificar si hay alg√∫n evento o callback que se haya disparado
    showDebugInfo('üîç Verificando si hay eventos de xDiagrams...');
    
    // Verificar si el script cre√≥ alg√∫n elemento en el DOM
    const allElements = document.querySelectorAll('*');
    const xDiagramsElements = Array.from(allElements).filter(el => 
      el.className && el.className.includes('xdiagrams') ||
      el.id && el.id.includes('xdiagrams') ||
      el.getAttribute('data-xdiagrams')
    );
    
    if (xDiagramsElements.length > 0) {
      showDebugInfo(`‚úÖ Elementos relacionados con xDiagrams encontrados: ${xDiagramsElements.length}`);
      xDiagramsElements.forEach((el, index) => {
        showDebugInfo(`Elemento ${index + 1}: ${el.tagName} - ${el.className || el.id}`);
      });
    }
    
    // Verificar si hay alg√∫n error en la consola relacionado con xDiagrams
    showDebugInfo('üîç Verificando errores en consola...');
  };

  const waitForXDiagrams = async (maxAttempts = 15) => {
    showDebugInfo('‚è≥ Esperando carga de xDiagrams...');
    
    for (let i = 0; i < maxAttempts; i++) {
      showDebugInfo(`Intento ${i + 1}/${maxAttempts} para cargar xDiagrams`);
      
      if (checkXDiagrams()) {
        showDebugInfo('üéâ xDiagrams cargado exitosamente!');
        
        // Investigar inmediatamente cuando se detecte XDiagrams
        showDebugInfo('üî¨ Investigando XDiagrams inmediatamente...');
        investigateScript();
        
        // Intentar inicializar el diagrama
        const initSuccess = initializeDiagram();
        if (initSuccess) {
          showDebugInfo('‚úÖ Diagrama inicializado correctamente');
        } else {
          showDebugInfo('‚ö†Ô∏è Diagrama cargado pero no se pudo inicializar');
        }
        
        return true;
      }
      
      // En el intento 5, investigar m√°s a fondo
      if (i === 4) {
        investigateScript();
      }
      
      // Esperar 1 segundo antes del siguiente intento
      await new Promise(resolve => setTimeout(resolve, 1000));
    }
    
    showDebugInfo('‚ùå xDiagrams no se carg√≥ despu√©s de todos los intentos');
    return false;
  };

  const configureClient = async () => {
    try {
      showDebugInfo('Iniciando configuraci√≥n de Auth0...');
      auth0 = await createAuth0Client({
        domain: 'dev-7kj3jxtxwwirocri.us.auth0.com',
        client_id: 'BORj4AB79Rho5yP5uSavuP4sern8pemZ',
        redirect_uri: window.location.origin,
        cacheLocation: 'localstorage'
      });
      showDebugInfo('‚úÖ Auth0 configurado correctamente');
    } catch (error) {
      showDebugInfo(`‚ùå Error configurando Auth0: ${error.message}`);
      console.error('Error configurando Auth0:', error);
    }
  };

  const updateUI = async () => {
    try {
      showDebugInfo('Verificando estado de autenticaci√≥n...');
      const isAuthenticated = await auth0.isAuthenticated();
      showDebugInfo(`Estado de autenticaci√≥n: ${isAuthenticated}`);
      
      if (isAuthenticated) {
        showDebugInfo('Usuario autenticado, obteniendo datos...');
        const user = await auth0.getUser();
        const token = await auth0.getTokenSilently();
        
        showDebugInfo(`Usuario obtenido: ${user.email || user.name}`);
        showDebugInfo('Token obtenido correctamente');
        
        // Mostrar informaci√≥n del usuario
        const userInfo = document.createElement('div');
        userInfo.className = 'user-info';
        userInfo.innerHTML = `
          <p>Bienvenido, ${user.name || user.email}</p>
          <button class="logout-btn" onclick="logout()">Cerrar sesi√≥n</button>
        `;
        
        // Insertar antes del div app
        const appDiv = document.getElementById('app');
        if (appDiv) {
          appDiv.parentNode.insertBefore(userInfo, appDiv);
          showDebugInfo('‚úÖ UI actualizada con informaci√≥n de usuario');
        } else {
          showDebugInfo('‚ùå No se encontr√≥ el div app');
        }
        
        console.log('Usuario autenticado:', user);
        console.log('Token:', token);
        
        // Mostrar loading mientras esperamos xDiagrams
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'loading';
        loadingDiv.innerHTML = `
          <div class="spinner"></div>
          <p>Cargando diagrama...</p>
        `;
        appDiv.appendChild(loadingDiv);
        
        // Cargar el script de xDiagrams din√°micamente
        try {
          await loadXDiagramsScript();
          showDebugInfo('‚úÖ Script cargado, esperando inicializaci√≥n...');
        } catch (error) {
          showDebugInfo(`‚ùå Error cargando script: ${error.message}`);
        }
        
        // Esperar a que xDiagrams se cargue
        const xDiagramsSuccess = await waitForXDiagrams();
        
        if (xDiagramsSuccess) {
          showDebugInfo('‚úÖ Diagrama listo para mostrar');
          loadingDiv.remove();
        } else {
          showDebugInfo('‚ùå Error: No se pudo cargar xDiagrams');
          loadingDiv.innerHTML = `
            <p>‚ùå Error al cargar el diagrama</p>
            <p>El script se carg√≥ pero no se inicializ√≥ correctamente</p>
            <p>Revisa la consola para m√°s detalles</p>
            <button onclick="location.reload()">Reintentar</button>
          `;
        }
        
      } else {
        showDebugInfo('Usuario no autenticado, mostrando login...');
        // Mostrar bot√≥n de login
        const authContainer = document.createElement('div');
        authContainer.className = 'auth-container';
        authContainer.innerHTML = `
          <h2>Acceso requerido</h2>
          <button class="login-btn" onclick="login()">Iniciar sesi√≥n</button>
        `;
        
        document.body.innerHTML = '';
        document.body.appendChild(authContainer);
        showDebugInfo('‚úÖ Pantalla de login mostrada');
      }
    } catch (error) {
      showDebugInfo(`‚ùå Error en updateUI: ${error.message}`);
      console.error('Error en updateUI:', error);
    }
  };

  const login = async () => {
    try {
      showDebugInfo('Iniciando proceso de login...');
      await auth0.loginWithRedirect();
    } catch (error) {
      showDebugInfo(`‚ùå Error en login: ${error.message}`);
      console.error('Error in login:', error);
    }
  };

  const logout = async () => {
    try {
      showDebugInfo('Iniciando logout...');
      await auth0.logout({
        returnTo: window.location.origin
      });
    } catch (error) {
      showDebugInfo(`‚ùå Error en logout: ${error.message}`);
      console.error('Error en logout:', error);
    }
  };

  const handleRedirectCallback = async () => {
    try {
      const query = window.location.search;
      showDebugInfo(`URL actual: ${window.location.href}`);
      showDebugInfo(`Query params: ${query}`);
      
      if (query.includes("code=") && query.includes("state=")) {
        showDebugInfo('Detectados par√°metros de Auth0, procesando callback...');
        await auth0.handleRedirectCallback();
        window.history.replaceState({}, document.title, "/");
        showDebugInfo('‚úÖ Callback procesado correctamente');
      } else {
        showDebugInfo('No hay par√°metros de Auth0 en la URL');
      }
    } catch (error) {
      showDebugInfo(`‚ùå Error en handleRedirectCallback: ${error.message}`);
      console.error('Error en handleRedirectCallback:', error);
    }
  };

  const init = async () => {
    try {
      showDebugInfo('üöÄ Iniciando aplicaci√≥n...');
      showDebugInfo(`URL actual: ${window.location.href}`);
      showDebugInfo(`User agent: ${navigator.userAgent}`);
      
      await configureClient();
      await handleRedirectCallback();
      await updateUI();
      
      showDebugInfo('‚úÖ Inicializaci√≥n completada');
    } catch (error) {
      showDebugInfo(`‚ùå Error en init: ${error.message}`);
      console.error('Error en init:', error);
    }
  };

  window.login = login;
  window.logout = logout;

  // Agregar listener para errores globales
  window.addEventListener('error', (event) => {
    showDebugInfo(`‚ùå Error global: ${event.error?.message || event.message}`);
    console.error('Error global:', event);
  });

  // Agregar listener para errores no capturados
  window.addEventListener('unhandledrejection', (event) => {
    showDebugInfo(`‚ùå Promesa rechazada: ${event.reason}`);
    console.error('Promesa rechazada:', event.reason);
  });

  init();
</script>
</body>
</html>

<!-- VERSION: 2.2 - Added timestamp to script URL to avoid cache -->