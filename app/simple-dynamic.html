<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P√°gina Simple con Datos Din√°micos</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e9ecef;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #0066cc;
        }
        
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
        
        .data-list {
            display: grid;
            gap: 15px;
        }
        
        .data-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #0066cc;
        }
        
        .item-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .item-details {
            color: #666;
            font-size: 0.9rem;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .login-prompt {
            text-align: center;
            padding: 40px;
            background: #e3f2fd;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .login-button {
            background: #0066cc;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            text-decoration: none;
            display: inline-block;
            margin-top: 10px;
        }
        
        .login-button:hover {
            background: #0052a3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Datos Din√°micos de SheetBest</h1>
        
        <div id="loginPrompt" class="login-prompt" style="display: none;">
            <h2>üîê Autenticaci√≥n Requerida</h2>
            <p>Necesitas iniciar sesi√≥n para ver los datos din√°micos.</p>
            <a href="/login.html" class="login-button">Iniciar Sesi√≥n</a>
        </div>
        
        <div id="loading" class="loading">
            <p>üîÑ Cargando datos din√°micos...</p>
        </div>
        
        <div id="error" class="error" style="display: none;">
            <p>‚ùå Error: <span id="errorMessage"></span></p>
        </div>
        
        <div id="content" style="display: none;">
            <div class="stats" id="stats">
                <!-- Estad√≠sticas se cargar√°n aqu√≠ -->
            </div>
            
            <h2>üìã Lista de Elementos</h2>
            <div class="data-list" id="dataList">
                <!-- Datos se cargar√°n aqu√≠ -->
            </div>
        </div>
    </div>

    <script>
        // Configuraci√≥n
        const API_ENDPOINT = '/.netlify/functions/raw-data';
        
        // Clase para manejar la autenticaci√≥n y datos
        class SimpleDataManager {
            constructor() {
                this.data = null;
                this.isAuthenticated = false;
            }
            
            // Verificar si el usuario est√° autenticado
            checkAuth() {
                const token = localStorage.getItem('auth0_token');
                if (token) {
                    // Verificar si el token no ha expirado
                    try {
                        const payload = JSON.parse(atob(token.split('.')[1]));
                        if (payload.exp * 1000 > Date.now()) {
                            this.isAuthenticated = true;
                            return true;
                        }
                    } catch (e) {
                        console.log('Token inv√°lido');
                    }
                }
                return false;
            }
            
            // Obtener token de autenticaci√≥n
            async getToken() {
                return localStorage.getItem('auth0_token');
            }
            
            // Cargar datos
            async loadData() {
                if (!this.checkAuth()) {
                    this.showLoginPrompt();
                    return;
                }
                
                try {
                    this.showLoading();
                    
                    const token = await this.getToken();
                    const response = await fetch(API_ENDPOINT, {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Error HTTP: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    this.data = result.data.items || [];
                    
                    this.hideLoading();
                    this.renderData();
                    
                } catch (error) {
                    console.error('Error cargando datos:', error);
                    this.showError(error.message);
                }
            }
            
            showLoading() {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('content').style.display = 'none';
                document.getElementById('error').style.display = 'none';
                document.getElementById('loginPrompt').style.display = 'none';
            }
            
            hideLoading() {
                document.getElementById('loading').style.display = 'none';
            }
            
            showError(message) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'none';
                document.getElementById('loginPrompt').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('errorMessage').textContent = message;
            }
            
            showLoginPrompt() {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'none';
                document.getElementById('error').style.display = 'none';
                document.getElementById('loginPrompt').style.display = 'block';
            }
            
            renderData() {
                if (!this.data || this.data.length === 0) {
                    document.getElementById('content').innerHTML = '<p>No hay datos disponibles</p>';
                    document.getElementById('content').style.display = 'block';
                    return;
                }
                
                // Renderizar estad√≠sticas
                this.renderStats();
                
                // Renderizar lista de datos
                this.renderDataList();
                
                document.getElementById('content').style.display = 'block';
            }
            
            renderStats() {
                const stats = this.getStats();
                const statsContainer = document.getElementById('stats');
                
                statsContainer.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-number">${stats.total}</div>
                        <div class="stat-label">Total Elementos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.types}</div>
                        <div class="stat-label">Tipos √önicos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.countries}</div>
                        <div class="stat-label">Pa√≠ses</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.withUrls}</div>
                        <div class="stat-label">Con URLs</div>
                    </div>
                `;
            }
            
            renderDataList() {
                const listContainer = document.getElementById('dataList');
                
                // Mostrar solo los primeros 20 elementos
                const itemsToShow = this.data.slice(0, 20);
                
                listContainer.innerHTML = itemsToShow.map(item => `
                    <div class="data-item">
                        <div class="item-title">${item.Name || 'Sin nombre'}</div>
                        <div class="item-details">
                            <strong>ID:</strong> ${item.ID || 'N/A'} | 
                            <strong>Tipo:</strong> ${item.Type || 'N/A'} | 
                            <strong>Pa√≠s:</strong> ${item.Country || 'N/A'}
                            ${item.URL ? ` | <strong>URL:</strong> <a href="${item.URL}" target="_blank">Ver</a>` : ''}
                        </div>
                    </div>
                `).join('');
            }
            
            getStats() {
                if (!this.data) return { total: 0, types: 0, countries: 0, withUrls: 0 };
                
                return {
                    total: this.data.length,
                    types: [...new Set(this.data.map(item => item.Type).filter(Boolean))].length,
                    countries: [...new Set(this.data.map(item => item.Country).filter(Boolean))].length,
                    withUrls: this.data.filter(item => item.URL).length
                };
            }
        }
        
        // Inicializar cuando la p√°gina est√© lista
        document.addEventListener('DOMContentLoaded', () => {
            const dataManager = new SimpleDataManager();
            dataManager.loadData();
            
            // Hacer disponible globalmente para debugging
            window.dataManager = dataManager;
        });
    </script>
</body>
</html>
